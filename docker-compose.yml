services:
  bats:
    build: .
    volumes:
      - .:/code
      - ./tests:/code/tests:ro  # Mount entire tests dir including helpers
      - ./testdata:/code/testdata:ro  # Ensure test images/data available
    working_dir: /code
    entrypoint: /bin/bash
    command:
      - -c
      - |
        mkdir -p /code/tests/test_helper
        ln -s /opt/bats-helpers/bats-support /code/tests/test_helper/bats-support 2>/dev/null || true
        ln -s /opt/bats-helpers/bats-assert /code/tests/test_helper/bats-assert 2>/dev/null || true
        ln -s /opt/bats-helpers/bats-file /code/tests/test_helper/bats-file 2>/dev/null || true
        bats /code/tests/